<!DOCTYPE html>
<html lang="en" dir="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Farhan al-Maliki — Video Finder</title>

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Fuse.js for fuzzy search -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

  <!-- Favicon (magnifier) -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23000000' d='M10 2a8 8 0 0 1 6.32 12.906l4.387 4.387a1 1 0 0 1-1.414 1.414l-4.387-4.387A8 8 0 1 1 10 2m0 2a6 6 0 1 0 0 12A6 6 0 0 0 10 4'/%3E%3C/svg%3E"/>

  <style>
    .kbd{ padding:.125rem .375rem; border:1px solid #e5e7eb; border-radius:.25rem; font-size:.75rem; font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; }
    .result:hover{ transform:translateY(-1px); }
    mark{ background:transparent; box-shadow:inset 0 -0.5em 0 0 rgba(250,204,21,.6); }
  </style>
</head>
<body class="bg-zinc-50 text-zinc-900">
  <div class="max-w-6xl mx-auto p-4 sm:p-8">
    <header class="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between mb-6">
      <div>
        <h1 class="text-2xl sm:text-3xl font-semibold tracking-tight">Farhan al-Maliki — Video Finder</h1>
        <p class="text-sm text-zinc-600">Client-side search across episodes and timestamped quotes. Hosted on GitHub Pages.</p>
      </div>
      <div class="text-xs text-zinc-500">Shortcuts: <span class="kbd">/</span> focus • <span class="kbd">Esc</span> clear</div>
    </header>

    <!-- Controls -->
    <div class="grid gap-3 sm:grid-cols-12 items-start mb-4">
      <div class="sm:col-span-7">
        <label class="sr-only" for="q">Search</label>
        <input id="q" type="search" placeholder="ابحث هنا … (اكتب كلمة موجودة في الترجمة)" class="w-full rounded-xl border border-zinc-300 bg-white px-4 py-2.5 shadow-sm focus:outline-none focus:ring-2 focus:ring-amber-400" />
      </div>
      <div class="sm:col-span-3">
        <select id="topic" class="w-full rounded-xl border border-zinc-300 bg-white px-3 py-2.5 shadow-sm focus:outline-none focus:ring-2 focus:ring-amber-400">
          <option value="">All topics</option>
        </select>
      </div>
      <div class="sm:col-span-2 flex gap-2">
        <button id="clearBtn" class="flex-1 rounded-xl border border-zinc-300 px-3 py-2.5 bg-white shadow-sm hover:bg-zinc-50">Clear</button>
        <button id="exportBtn" title="Export results to CSV" class="rounded-xl border border-zinc-300 px-3 py-2.5 bg-white shadow-sm hover:bg-zinc-50">CSV</button>
      </div>
    </div>

    <!-- Stats -->
    <div id="stats" class="text-sm text-zinc-600 mb-2"></div>

    <!-- Results -->
    <div id="results" class="grid gap-3"></div>

    <footer class="mt-10 text-xs text-zinc-500">
      <p>Data source: <code>data/index.json</code>. If absent, demo data (embedded) is used. Built with Fuse.js. Inspired by ippsec.rocks.</p>
    </footer>
  </div>

  <script>
    // ===== Config =====
    // This is the file the workflow generates:
    const DATA_URL = 'data/index.json';

    // Demo data (used only if DATA_URL is missing)
    const demoData = [
      {
        id: "DEMO-1",
        title: "Demo Episode",
        series: "Demo",
        date: "2023-01-01",
        url: "https://www.youtube.com/watch?v=XXXXXXXX",
        lang: "ar",
        topics: ["demo"],
        terms: [
          { term: "", t: 12, text: "مثال على نتيجة بحث عربية." },
          { term: "", t: 45, text: "جملة أخرى لاختبار العرض." }
        ]
      }
    ];

    // ===== State =====
    let videos = [];
    let fuse;
    let flatRows = [];
    let lastResults = [];

    // ===== Helpers =====
    const $ = (sel) => document.querySelector(sel);
    const resultsEl = $("#results");

    function fmtTime(sec){
      sec = Math.max(0, Math.floor(+sec || 0));
      const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s = sec%60;
      return (h? h+":" : "") + String(m).padStart(2,'0') + ":" + String(s).padStart(2,'0');
    }

    function ytAt(url, t){
      try{
        const u = new URL(url);
        if(u.hostname.includes('youtube.com') || u.hostname.includes('youtu.be')){
          u.searchParams.set('t', Math.floor(t));
          return u.toString();
        }
      }catch(e){}
      return url + (url.includes('#')? '&' : '#') + 't=' + Math.floor(t);
    }

    function highlight(text, query){
      if(!query) return text;
      const esc = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const re = new RegExp('(' + esc + ')', 'ig');
      return String(text).replace(re, '<mark>$1</mark>');
    }

    function updateStats(count){
      const q = $('#q').value.trim();
      const topic = $('#topic').value;
      const parts = [];
      parts.push(`${count} result${count===1?'':'s'}`);
      if(q) parts.push(`for “${q}”`);
      if(topic) parts.push(`in topic “${topic}”`);
      $('#stats').textContent = parts.join(' ');
    }

    function downloadCSV(rows){
      const headers = ['episode_id','title','series','date','topic','term','timestamp','quote','url'];
      const escape = (v) => '"' + String(v ?? '').replace(/"/g,'""') + '"';
      const csv = [headers.join(',')].concat(rows.map(r => [r.id, r.title, r.series, r.date, r.topic, r.term, fmtTime(r.t), r.text, ytAt(r.url, r.t)].map(escape).join(','))).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'results.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // ===== UI Build =====
    function rebuildUI(){
      // Topics dropdown
      const topics = new Set();
      videos.forEach(v => (v.topics||[]).forEach(t => topics.add(t)));
      const topicSel = $('#topic');
      const current = topicSel.value;
      topicSel.innerHTML = '<option value="">All topics</option>' + Array.from(topics).sort().map(t => `<option>${t}</option>`).join('');
      if(Array.from(topics).includes(current)) topicSel.value = current;

      // Flatten transcript rows
      flatRows = [];
      for(const v of videos){
        for(const trm of (v.terms||[])){
          flatRows.push({
            id: v.id,
            title: v.title || v.id,
            series: v.series || '',
            date: v.date || '',
            url: v.url,
            lang: v.lang || '',
            topic: (v.topics||[])[0] || '',
            term: trm.term || '',
            t: trm.t,
            text: trm.text || '',
            tags: trm.tags || []
          });
        }
      }

      // Fuse index
      fuse = new Fuse(flatRows, {
        includeMatches: false,
        threshold: 0.35,
        ignoreLocation: true,
        keys: [
          {name:'text',  weight: 0.6},
          {name:'term',  weight: 0.3},
          {name:'title', weight: 0.15},
          {name:'topic', weight: 0.2}
        ]
      });

      // Initial search (from hash)
      const params = new URLSearchParams(location.hash.slice(1));
      $('#q').value = params.get('q') || '';
      $('#topic').value = params.get('topic') || '';
      runSearch();
    }

    function runSearch(){
      const q = $('#q').value.trim();
      const topic = $('#topic').value;

      // Persist query in URL hash
      const p = new URLSearchParams();
      if(q) p.set('q', q);
      if(topic) p.set('topic', topic);
      history.replaceState(null, '', '#' + p.toString());

      // Filter by topic first
      let rows = flatRows;
      if(topic) rows = rows.filter(r => r.topic === topic || (r.tags||[]).includes(topic));

      // Search or list
      let results = [];
      if(q){
        results = fuse.search(q).map(r => r.item).filter(r => !topic || r.topic === topic || (r.tags||[]).includes(topic));
      } else {
        results = rows.slice().sort((a,b) => (b.date||'').localeCompare(a.date||'') || a.t - b.t);
      }

      lastResults = results;
      renderResultsGrouped(results, q);
    }

    function groupBy(arr, key){
      const m = new Map();
      for(const x of arr){
        const k = x[key];
        if(!m.has(k)) m.set(k, []);
        m.get(k).push(x);
      }
      return m;
    }

    function renderResultsGrouped(rows, q){
      const grouped = groupBy(rows, 'id');
      const cards = [];
      for(const [id, items] of grouped){
        items.sort((a,b)=>a.t-b.t);
        const v = items[0];
        const title = v.title || id;
        const date  = v.date || '';
        const series= v.series || '';
        const topic = v.topic || '';
        const count = items.length;

        const listFirst = items.slice(0, 10).map(it => {
          const jump = ytAt(it.url, it.t);
          const text = highlight(it.text || it.term || '', q);
          return `<li class="flex items-start gap-2">
                    <a class="shrink-0 rounded-lg bg-zinc-100 px-2 py-0.5 text-sm" href="${jump}" target="_blank" rel="noopener">${fmtTime(it.t)}</a>
                    <span class="text-sm text-zinc-700">${text}</span>
                  </li>`;
        }).join('');

        const extra = items.length - 10;
        const listRest = extra > 0 ? `
          <details class="mt-2">
            <summary class="cursor-pointer text-sm text-amber-700 hover:underline">Show ${extra} more timestamps</summary>
            <ul class="mt-2 grid gap-2">
              ${items.slice(10).map(it => {
                const jump = ytAt(it.url, it.t);
                return `<li class="flex items-start gap-2">
                          <a class="shrink-0 rounded-lg bg-zinc-100 px-2 py-0.5 text-sm" href="${jump}" target="_blank" rel="noopener">${fmtTime(it.t)}</a>
                          <span class="text-sm text-zinc-700">${highlight(it.text||it.term||'', q)}</span>
                        </li>`;
              }).join('')}
            </ul>
          </details>` : '';

        cards.push(`
          <div class="result block rounded-xl border border-zinc-200 bg-white p-4 shadow-sm hover:shadow-md">
            <div class="flex items-center justify-between gap-3">
              <div class="font-medium">${title}</div>
              <div class="text-xs text-zinc-500">${series} ${series && date ? '•' : ''} ${date}</div>
            </div>
            <div class="mt-1 flex flex-wrap items-center gap-2 text-sm">
              ${topic ? `<span class="rounded-lg bg-zinc-100 px-2 py-0.5">${topic}</span>` : ''}
              <span class="rounded-lg bg-amber-100 px-2 py-0.5">${count} hit${count===1?'':'s'}</span>
            </div>
            <ul class="mt-3 grid gap-2">${listFirst}</ul>
            ${listRest}
          </div>
        `);
      }

      updateStats(rows.length);
      resultsEl.innerHTML = cards.join('') || `<div class="text-sm text-zinc-500">No matches. Try a different word (in the same language as the transcript).</div>`;
    }

    // ===== Events =====
    document.addEventListener('keydown', (e) => {
      if(e.key === '/' && document.activeElement !== $('#q')){ e.preventDefault(); $('#q').focus(); $('#q').select(); }
      if(e.key === 'Escape'){ $('#q').value=''; runSearch(); }
    });
    $('#q').addEventListener('input', runSearch);
    $('#topic').addEventListener('change', runSearch);
    $('#clearBtn').addEventListener('click', () => { $('#q').value=''; $('#topic').value=''; runSearch(); $('#q').focus(); });
    $('#exportBtn').addEventListener('click', () => downloadCSV(lastResults));

    // ===== Data load =====
    async function maybeLoadExternal(){
      try{
        const r = await fetch(DATA_URL, { cache: 'no-store' });
        if (r.ok) {
          const data = await r.json();
          if (Array.isArray(data)) return data;
        }
      }catch(_){}
      return demoData;
    }

    (async function init(){
      videos = await maybeLoadExternal();
      rebuildUI();
    })();
  </script>
</body>
</html>
