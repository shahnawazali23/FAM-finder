<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Farhan al-Maliki — Video Finder</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Fuse.js for fuzzy search -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23000000' d='M10 2a8 8 0 0 1 6.32 12.906l4.387 4.387a1 1 0 0 1-1.414 1.414l-4.387-4.387A8 8 0 1 1 10 2m0 2a6 6 0 1 0 0 12A6 6 0 0 0 10 4'/%3E%3C/svg%3E"/>
  <style>
    .kbd{ padding:0.125rem 0.375rem; border:1px solid #d4d4d8; border-radius:0.25rem; font-size:0.75rem; font-family:monospace; }
    .result:hover { transform: translateY(-1px); }
    mark { background: transparent; box-shadow: inset 0 -0.5em 0 0 rgba(250, 204, 21, 0.6); }
  </style>
</head>
<body class="bg-zinc-50 text-zinc-900">
  <div class="max-w-6xl mx-auto p-4 sm:p-8">
    <header class="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between mb-6">
      <div>
        <h1 class="text-2xl sm:text-3xl font-semibold tracking-tight">Farhan al-Maliki — Video Finder</h1>
        <p class="text-sm text-zinc-600">Search across episodes, topics, and timestamped terms. Client-side only.</p>
      </div>
      <div class="text-xs text-zinc-500">Shortcuts: <span class="kbd">/</span> focus • <span class="kbd">Esc</span> clear • <span class="kbd">↑/↓</span> navigate • <span class="kbd">Enter</span> open</div>
    </header>

    <!-- Controls -->
    <div class="grid gap-3 sm:grid-cols-12 items-start mb-4">
      <div class="sm:col-span-7">
        <input id="q" type="search" placeholder="Search terms, topics, or quotes…" class="w-full rounded-xl border border-zinc-300 bg-white px-4 py-2.5 shadow-sm focus:outline-none focus:ring-2 focus:ring-amber-400" />
      </div>
      <div class="sm:col-span-3">
        <select id="topic" class="w-full rounded-xl border border-zinc-300 bg-white px-3 py-2.5 shadow-sm focus:outline-none focus:ring-2 focus:ring-amber-400">
          <option value="">All topics</option>
        </select>
      </div>
      <div class="sm:col-span-2 flex gap-2">
        <button id="clearBtn" class="flex-1 rounded-xl border border-zinc-300 px-3 py-2.5 bg-white shadow-sm hover:bg-zinc-50">Clear</button>
        <button id="exportBtn" class="rounded-xl border border-zinc-300 px-3 py-2.5 bg-white shadow-sm hover:bg-zinc-50">CSV</button>
      </div>
    </div>

    <div id="stats" class="text-sm text-zinc-600 mb-2"></div>
    <div id="results" class="grid gap-3"></div>

    <footer class="mt-10 text-xs text-zinc-500">
      <p>Drop your data into <code>data/videos.json</code> (or later, we’ll generate it automatically). If absent, demo data is used.</p>
    </footer>
  </div>

  <script>
    // Demo data
    const demoData = [
      {
        id: "HT-021",
        title: "Haqāʾiq al-Tārīkh — Episode 021",
        series: "Haqāʾiq al-Tārīkh",
        date: "2023-11-02",
        url: "https://www.youtube.com/watch?v=XXXXXXXX",
        lang: "ar",
        topics: ["Saqifah","Caliphate","Early Sources"],
        terms: [
          { term: "Saqifah", t: 732, text: "Narratives around the meeting at Saqifah and competing isnād clusters." },
          { term: "Isnād", t: 945, text: "Comparing regional transmission lines in early reports." }
        ]
      }
    ];

    const DATA_URL = "data/videos.json";
    let videos = [];
    let fuse; let flatRows = [];

    const $ = sel => document.querySelector(sel);
    const resultsEl = $("#results");

    function fmtTime(sec){
      sec = Math.floor(+sec||0);
      const m = Math.floor(sec/60), s = sec%60;
      return `${m}:${String(s).padStart(2,'0')}`;
    }
    function ytAt(url, t){ return url + "&t=" + Math.floor(t); }
    function highlight(text, q){ if(!q) return text; return text.replace(new RegExp("(" + q + ")", "ig"), "<mark>$1</mark>"); }

    function rebuildUI(){
      flatRows = [];
      videos.forEach(v => (v.terms||[]).forEach(trm => flatRows.push({...v,...trm})));
      fuse = new Fuse(flatRows, { includeMatches:true, threshold:0.35, keys:["term","text","title","series","topics"] });
      runSearch();
    }

    function runSearch(){
      const q = $("#q").value.trim();
      let rows = q ? fuse.search(q).map(r => r.item) : flatRows;
      renderResults(rows, q);
    }

    function renderResults(rows,q){
      $("#stats").textContent = `${rows.length} results`;
      resultsEl.innerHTML = rows.map(r => `
        <a href="${ytAt(r.url,r.t)}" target="_blank" class="result block rounded-xl border border-zinc-200 bg-white p-4 shadow-sm hover:shadow-md">
          <div class="flex justify-between text-sm">
            <span class="font-medium">${r.title}</span>
            <span class="text-zinc-500">${r.date}</span>
          </div>
          <div class="mt-1 text-sm">
            <span class="bg-amber-100 px-2 py-0.5 rounded">${highlight(r.term,q)}</span>
            <span class="bg-zinc-100 px-2 py-0.5 rounded">${fmtTime(r.t)}</span>
          </div>
          <p class="mt-2 text-sm text-zinc-700">${highlight(r.text,q)}</p>
        </a>
      `).join("");
    }

    $("#q").addEventListener("input", runSearch);
    $("#clearBtn").addEventListener("click", () => { $("#q").value=""; runSearch(); });

    (async function init(){
      try{
        const resp = await fetch(DATA_URL,{cache:"no-store"});
        videos = resp.ok ? await resp.json() : demoData;
      }catch{ videos = demoData; }
      rebuildUI();
    })();
  </script>
</body>
</html>
